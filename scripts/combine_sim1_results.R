# This script combines simulation results generated by `simulation_1.R`.
#
# Each simulation is saved as a .rds file containing:
#   - data: a list with simulated inputs
#       - x: n × p input matrix
#       - y: outcome vector
#       - e: p × p eigenbasis matrix
#       - beta
#       - argparse values (e.g., sim_id, effect size, seed)
#   - fit: a nested list of LASSO fits, structured as:
#       - space: "pixel" or "freq"
#         - lambda: "lambda.min" or "lambda.1se"
#           - acc: classification accuracy
#           - auc: area under the ROC curve
#           - coefs: named vector of coefficients
#           - pvals: p-values corresponding to coefficients
#
# This script extracts:
#   (1) A list of raw simulated `data` indexed by sim_id; hparams such as
#       effect size and number of samples per iteration
#   (2) A summary data.frame: sim_id, space, lambda, acc, auc
#   (3) A long-format data.frame: sim_id, space, lambda, variable, coef, pval
#
# Output:
#   - combined_results.rds: list(metrics, coefs_pvals, data)

packages <- c("optparse")
new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_packages) > 0) install.packages(new_packages)
sapply(packages, require, character.only = TRUE)


# ---------- Capture parameters ----------
option_list <- list(
  optparse::make_option(
    "result_dir",
    type = "character",
    help = "Directory that saves .rds files for each iter"
  ),
  optparse::make_option(
    "out_dir",
    type = "character",
    help = "Directory to save the combined .rds file"
  )
)

opt_parser <- optparse::OptionParser(option_list = option_list)
opt <- optparse::parse_args(opt_parser)


# ---------- Extract Results ----------
# List all .rds files
files <- list.files(
  opt$result_dir,
  pattern = "^sim_\\d+\\.rds$",
  full.names = TRUE
)

# Initialize lists to collect data
data_list <- list()
auc_acc_list <- list()
coefs_pvals_list <- list()

for (f in files) {
  sim_id <- as.integer(gsub("\\D", "", basename(f)))
  res <- tryCatch(readRDS(f), error = function(e) NULL)
  if (is.null(res)) next

  # Extract simulated data
  data_list[[as.character(sim_id)]] <- res$data

  # Extract fitted results
  for (space in names(res$fit)) {
    for (lam in names(res$fit[[space]])) {
      res_sl <- res$fit[[space]][[lam]]

      # Add to auc/acc list
      auc_acc_list[[length(auc_acc_list) + 1]] <- data.frame(
        sim_id = sim_id,
        space = space,
        lambda = lam,
        auc = as.numeric(res_sl$auc),
        acc = res_sl$acc
      )

      # Add to coefs/pvals list
      coefs_pvals_list[[length(coefs_pvals_list) + 1]] <- data.frame(
        sim_id = sim_id,
        space = space,
        lambda = lam,
        coef = res_sl$coefs,
        pval = res_sl$pvals
      )
    }
  }
}

# hparams, beta and e are the same across iterations
hparams <- data_list[[1]]$hparams[c("effect", "n_sample")]
beta <- data_list[[1]]$beta
e <- data_list[[1]]$e

# Extract input matrix from each simulation
x <- lapply(data_list, function(d) d$x)
x <- setNames(x, names(data_list))

# Extract outcome vector from each simulation
y <- lapply(data_list, function(d) d$y)
y <- setNames(y, names(data_list))


# Combine model outputs into data.frames
auc_acc_df <- do.call(rbind, auc_acc_list)
coefs_pvals_df <- do.call(rbind, coefs_pvals_list)

# Save results
saveRDS(
  list(
    x = x,
    y = y,
    beta = beta,
    e = e,
    hparams = hparams,
    auc_acc = auc_acc_df,
    coefs_pvals = coefs_pvals_df
  ),
  file = file.path(opt$out_dir, "sim1_combined_results.rds")
)
