# This script combines simulation results generated by `simulation_1.R`.
#
# Each simulation is saved as a .rds file containing:
#   - data: a list with simulated inputs
#       - x: n × p input matrix
#       - y: outcome vector
#       - e: p × p eigenbasis matrix
#       - beta
#       - argparse values (e.g., sim_id, effect size, seed)
#   - fit: a nested list of LASSO fits, structured as:
#       - space: "pixel" or "freq"
#         - lambda: "lambda.min" or "lambda.1se"
#           - acc: classification accuracy
#           - auc: area under the ROC curve
#           - coefs: named vector of coefficients
#           - pvals: p-values corresponding to coefficients
#
# This script extracts:
#   (1) A list of raw simulated `data` indexed by sim_id; hparams such as
#       effect size and number of samples per iteration
#   (2) A summary data.frame: sim_id, space, lambda, acc, auc
#   (3) A long-format data.frame: sim_id, space, lambda, variable, coef, pval
#
# Output:
#   - combined_results.rds: list(metrics, coefs_pvals, data)

packages <- c("optparse")
new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_packages) > 0) install.packages(new_packages)
sapply(packages, require, character.only = TRUE)


# ---------- Capture parameters ----------
option_list <- list(
  optparse::make_option(
    "result_dir",
    type = "character",
    help = "Directory that saves .rds files for each iter"
  ),
  optparse::make_option(
    "out_dir",
    type = "character",
    help = "Directory to save the combined .rds file"
  )
)

opt_parser <- optparse::OptionParser(option_list = option_list)
opt <- optparse::parse_args(opt_parser)


# ---------- Extract Results ----------
# List all .rds files
files <- list.files(
  opt$result_dir,
  pattern = "^sim_\\d+\\.rds$",
  full.names = TRUE
)

# Initial empty vector / list to collect results
beta_vec <- c()
hparams <- c()
e <- c()
x_list <- list()
y_list <- list()
auc_acc_list <- list()
coefs_pvals_list <- list()

for (i in seq_along(files)) {
  f <- files[i]
  sim_id <- as.integer(gsub("\\D", "", basename(f)))
  res <- tryCatch(readRDS(f), error = function(e) NULL)
  if (is.null(res)) next

  if (i == 1) {
    beta_vec <- c(beta_vec, res$data$beta)
    hparams <- c(hparams, res$data$hparams[c("effect", "n_sample")])
    e <- c(e, res$data$e)
  }

  id <- as.character(sim_id)
  x_list[[id]] <- res$data$x
  y_list[[id]] <- res$data$y

  for (space in names(res$fit)) {
    for (lam in names(res$fit[[space]])) {
      res_sl <- res$fit[[space]][[lam]]

      # Add to auc/acc list
      auc_acc_list[[length(auc_acc_list) + 1]] <- data.frame(
        sim_id = id,
        space = space,
        lambda = lam,
        auc = as.numeric(res_sl$auc),
        acc = res_sl$acc
      )

      # Add to coefs/pvals list
      coefs_pvals_list[[length(coefs_pvals_list) + 1]] <- data.frame(
        sim_id = id,
        space = space,
        lambda = lam,
        coef = res_sl$coefs,
        pval = res_sl$pvals
      )
    }
  }
}


# Combine model outputs into data.frames / matrix / array
x_arr <- array(NA, dim = c(dim(x_list[[1]]), length(x_list)))
for (i in seq_along(x_list)) {
  x_arr[, , i] <- x_list[[i]]
}
y_mat <- do.call(rbind, y_list)
auc_acc_df <- do.call(rbind, auc_acc_list)
coefs_pvals_df <- do.call(rbind, coefs_pvals_list)

# Save results
saveRDS(
  list(
    x = x_arr,
    y = y_mat,
    beta = beta_vec,
    e = e,
    hparams = hparams,
    auc_acc = auc_acc_df,
    coefs_pvals = coefs_pvals_df
  ),
  file = file.path(opt$out_dir, "sim1_combined_results.rds")
)
